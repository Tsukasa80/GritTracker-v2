<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="家計簿">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="シンプルで使いやすい家計簿アプリ">
    <title>家計簿アプリ</title>
    
    <!-- PWA用のマニフェストファイル -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWuteioreexv+OCouODl+ODqiIsCiAgInNob3J0X25hbWUiOiAi5a616KiI56C/IiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjVmNWY1IiwKICAidGhlbWVfY29sb3IiOiAiIzRhOTBlMiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBeU9EZ2lJR1pwYkd3OUluVnliQ2doSXpkcUlpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBpQXZQZ289IiwKICAgICAgInNpemVzIjogImFueSIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    
    <!-- iOS用アイコン -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAyODgiIGZpbGw9InVybCgjN2opIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPiA8L3N2Zz4K">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #4a90e2;
            color: white;
            text-align: center;
            padding: 30px 0;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #357abd;
        }

        .data-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .data-section h2 {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        .budget-section {
            background-color: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .budget-section h2 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .budget-form {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .budget-form label {
            font-weight: 600;
            color: #856404;
            white-space: nowrap;
        }

        .budget-form input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ffeaa7;
            border-radius: 6px;
            font-size: 1rem;
        }

        .budget-form input:focus {
            outline: none;
            border-color: #fdcb6e;
        }

        .summary {
            background-color: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            gap: 20px;
            justify-content: space-between;
        }

        .summary-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .summary-item h3 {
            color: #4a90e2;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .summary-item .amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .summary-item:last-child .amount {
            color: #28a745;
        }

        .summary-item:last-child .amount.negative {
            color: #dc3545;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 20px 0;
                margin-bottom: 20px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .form-section, .data-section {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .budget-form {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .budget-form label {
                text-align: left;
                margin-bottom: 5px;
            }

            .summary-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .summary-item {
                padding: 12px;
            }
            
            .summary-item h3 {
                font-size: 0.9rem;
            }
            
            .summary-item .amount {
                font-size: 1.1rem;
            }
            
            /* テーブルをスマホ向けに最適化 */
            table {
                font-size: 0.8rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            thead, tbody, th, td, tr {
                display: block;
            }
            
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            tbody tr {
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                background: white;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                position: relative;
                display: block !important;
            }
            
            tbody td {
                border: none;
                position: relative;
                padding: 8px 0 8px 120px !important;
                text-align: left !important;
                white-space: normal;
                word-wrap: break-word;
            }
            
            tbody td:before {
                content: attr(data-label) ": ";
                position: absolute;
                left: 0;
                width: 110px;
                font-weight: bold;
                color: #555;
            }
            
            /* フィルター部分 */
            .filter-section {
                flex-direction: column;
                gap: 10px;
                align-items: stretch !important;
            }
            
            .filter-section > div {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            /* 項目管理セクション */
            .budget-section[style*="background-color: #f0f8ff"] > div:first-child > div:first-child {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .budget-section[style*="background-color: #f0f8ff"] > div:first-child > div:last-child {
                flex-direction: column;
                gap: 10px;
            }
            
            /* ボタンサイズの調整 */
            .btn {
                padding: 15px 25px;
                font-size: 1.1rem;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            /* 入力フィールドの調整 */
            input, select, textarea {
                padding: 15px 12px !important;
                font-size: 1.1rem !important;
                min-height: 50px;
                border-radius: 8px;
            }
            
            textarea {
                min-height: 100px;
            }
            
            /* ラジオボタンとチェックボックス */
            input[type="radio"] {
                width: 20px;
                height: 20px;
                margin-right: 10px;
            }
            
            /* 操作ボタンの調整 */
            button {
                min-height: 44px;
                padding: 12px 16px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>💰 家計簿アプリ</h1>
            <p class="subtitle">あなたの家計管理をサポートします</p>
        </header>

        <div class="form-section">
            <h2>📝 収支の記録</h2>
            <form id="expense-form">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="margin-bottom: 10px; display: block;">種別</label>
                    <div style="display: flex; gap: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                            <input type="radio" id="type-expense" name="type" value="expense" checked style="margin-right: 8px;">
                            <span style="color: #dc3545;">💸 支出</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                            <input type="radio" id="type-income" name="type" value="income" style="margin-right: 8px;">
                            <span style="color: #28a745;">💰 収入</span>
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="item">項目</label>
                        <select id="item" name="item" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease;">
                            <option value="">項目を選択してください</option>
                            <!-- 項目オプションはJavaScriptで動的に生成 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">金額（円）</label>
                        <input type="number" id="amount" name="amount" placeholder="例：1500" min="0" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="date">日付</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="memo">備考（任意）</label>
                    <textarea id="memo" name="memo" rows="3" placeholder="例：コンビニで昼食、交通費（電車代）、ボーナス支給など" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; transition: border-color 0.3s ease;"></textarea>
                </div>
                <button type="submit" class="btn" id="submit-button">記録を追加</button>
            </form>
        </div>

        <div class="data-section">
            <div class="budget-section">
                <h2>💰 予算設定</h2>
                <div class="budget-form">
                    <label for="budget">今月の利用可能金額（円）</label>
                    <input type="number" id="budget" min="0" step="1" placeholder="例：50000">
                    <button onclick="setBudget()" class="btn" style="margin-left: 10px; padding: 8px 20px;">設定</button>
                </div>
            </div>
            
            <div class="budget-section" style="background-color: #f0f8ff; border: 1px solid #4a90e2;">
                <h2>📝 項目管理</h2>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                            <input type="radio" name="item-type" value="expense" checked style="margin-right: 8px;">
                            <span style="color: #dc3545;">💸 支出項目</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                            <input type="radio" name="item-type" value="income" style="margin-right: 8px;">
                            <span style="color: #28a745;">💰 収入項目</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="new-item-name" placeholder="新しい項目名" style="flex: 1; padding: 8px 12px; border: 2px solid #4a90e2; border-radius: 6px; font-size: 1rem;">
                        <button onclick="addNewItem()" class="btn" style="padding: 8px 20px;">追加</button>
                    </div>
                </div>
                <div id="items-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: white;">
                    <!-- 項目一覧がここに表示される -->
                </div>
            </div>

            <div class="summary">
                <div class="summary-row">
                    <div class="summary-item">
                        <h3>今月の利用可能金額</h3>
                        <div class="amount" id="budget-amount">¥0</div>
                    </div>
                    <div class="summary-item">
                        <h3>今月の収入合計</h3>
                        <div class="amount" id="income-amount" style="color: #28a745;">¥0</div>
                    </div>
                    <div class="summary-item">
                        <h3>今月の支出合計</h3>
                        <div class="amount" id="expense-amount" style="color: #dc3545;">¥0</div>
                    </div>
                    <div class="summary-item">
                        <h3>利用可能残高</h3>
                        <div class="amount" id="remaining-amount">¥0</div>
                    </div>
                </div>
            </div>
            
            <h2>📊 収支一覧</h2>
            <div class="filter-section" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div>
                    <label for="year-select" style="margin-right: 8px; font-weight: 600;">年：</label>
                    <select id="year-select" style="padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem;">
                        <!-- 年のオプションはJavaScriptで動的に生成 -->
                    </select>
                </div>
                <div>
                    <label for="month-select" style="margin-right: 8px; font-weight: 600;">月：</label>
                    <select id="month-select" style="padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem;">
                        <option value="">全ての月</option>
                        <option value="01">1月</option>
                        <option value="02">2月</option>
                        <option value="03">3月</option>
                        <option value="04">4月</option>
                        <option value="05">5月</option>
                        <option value="06">6月</option>
                        <option value="07">7月</option>
                        <option value="08">8月</option>
                        <option value="09">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>
                </div>
                <div>
                    <label style="margin-right: 8px; font-weight: 600;">並び替え：</label>
                    <button id="sort-button" onclick="toggleSort()" class="btn" style="padding: 8px 16px; font-size: 0.9rem; background-color: #6c757d;">
                        📅 日付 (新→古)
                    </button>
                </div>
            </div>
            <table id="expense-table">
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>種別</th>
                        <th>項目</th>
                        <th>金額</th>
                        <th>備考</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="expense-tbody">
                    <tr>
                        <td colspan="6" class="empty-message">
                            まだデータがありません。<br>
                            上のフォームから収支を記録してみましょう！
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="form-section" style="background-color: #fff9e6; border: 2px solid #ffd93d;">
            <h2 style="color: #b8860b;">🏆 今月の振り返り</h2>
            <div style="margin-bottom: 20px;">
                <p style="color: #8b7355; margin-bottom: 15px;">今月を振り返って、特に価値があった支出と改善したい支出を選んでみましょう。</p>
                
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <button onclick="showBestWorstSelection('best')" class="btn" style="background-color: #28a745; flex: 1;">
                        ⭐ ベスト支出を選ぶ
                    </button>
                    <button onclick="showBestWorstSelection('worst')" class="btn" style="background-color: #dc3545; flex: 1;">
                        ⚠️ ワースト支出を選ぶ
                    </button>
                </div>
                
                <div id="review-selection-area" style="display: none; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background-color: white; margin-bottom: 20px;">
                    <h3 id="selection-title" style="margin-bottom: 15px; color: #4a90e2;"></h3>
                    <div id="expense-selection-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
                    <div id="selected-items-area" style="display: none; margin-top: 20px;"></div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                        <button onclick="saveMonthlyReview()" class="btn" style="background-color: #28a745;">保存</button>
                        <button onclick="cancelSelection()" class="btn" style="background-color: #6c757d;">キャンセル</button>
                    </div>
                </div>
                
                <div id="review-summary" style="background-color: white; border-radius: 8px; padding: 20px; border: 1px solid #ddd;">
                    <h3 style="color: #4a90e2; margin-bottom: 15px;">📊 振り返りサマリー</h3>
                    <div id="review-summary-content">
                        <p style="color: #888; text-align: center; font-style: italic;">まだ振り返りデータがありません。<br>上のボタンから今月のベスト・ワースト支出を選んでみましょう！</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ローカルストレージのキー
        const STORAGE_KEY = 'kakeiboRecords';
        const BUDGET_KEY = 'kakeiboBudget';
        const ITEMS_KEY = 'kakeiboItems';
        const MONTHLY_REVIEW_KEY = 'kakeiboMonthlyReview';

        // データを保存する配列
        let expenses = [];
        let monthlyBudget = 0;
        let editingExpenseId = null; // 編集中のアイテムID
        let itemsList = []; // 項目マスタ
        let monthlyReviews = {}; // 月次振り返りデータ
        let sortOrder = 'desc'; // 並び替え順序: 'desc' (新→古) or 'asc' (古→新)

        // ローカルストレージからデータを読み込む関数
        function loadDataFromStorage() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    expenses = JSON.parse(storedData);
                }
                
                const storedBudget = localStorage.getItem(BUDGET_KEY);
                if (storedBudget) {
                    monthlyBudget = parseInt(storedBudget);
                    document.getElementById('budget').value = monthlyBudget;
                }
                
                const storedItems = localStorage.getItem(ITEMS_KEY);
                if (storedItems) {
                    itemsList = JSON.parse(storedItems);
                    // 既存データにorder情報がない場合は追加
                    initializeOrderForExistingItems();
                } else {
                    // 初期項目データを設定
                    initializeDefaultItems();
                }
                
                const storedReviews = localStorage.getItem(MONTHLY_REVIEW_KEY);
                if (storedReviews) {
                    monthlyReviews = JSON.parse(storedReviews);
                }
                
                return true;
            } catch (error) {
                console.error('データの読み込みに失敗しました:', error);
                alert('保存されたデータの読み込みに失敗しました。');
            }
            return false;
        }

        // ローカルストレージにデータを保存する関数
        function saveDataToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
                localStorage.setItem(BUDGET_KEY, monthlyBudget.toString());
                localStorage.setItem(ITEMS_KEY, JSON.stringify(itemsList));
                localStorage.setItem(MONTHLY_REVIEW_KEY, JSON.stringify(monthlyReviews));
            } catch (error) {
                console.error('データの保存に失敗しました:', error);
                alert('データの保存に失敗しました。');
            }
        }

        // ページ読み込み時の初期化処理
        function initializeApp() {
            // 今日の日付をデフォルトで設定
            document.getElementById('date').valueAsDate = new Date();

            // ローカルストレージからデータを読み込む
            loadDataFromStorage();

            // 年セレクトボックスを初期化
            initializeYearSelect();

            // 現在の年月を選択
            setCurrentYearMonth();

            // 項目セレクトボックスを更新
            updateItemSelect();

            // フィルタリングしてテーブルを描画
            filterAndRenderRecords();

            // 予算表示を更新
            updateBudgetDisplay();

            // セレクトボックスのイベントリスナーを設定
            setupFilterEventListeners();
            
            // 種別変更時に項目セレクトボックスを更新
            document.querySelectorAll('input[name="type"]').forEach(radio => {
                radio.addEventListener('change', updateItemSelect);
            });
            
            // 項目管理の種別変更時に項目一覧を更新
            document.querySelectorAll('input[name="item-type"]').forEach(radio => {
                radio.addEventListener('change', updateItemsList);
            });
            
            // 項目一覧を初期表示
            updateItemsList();
            
            // 月次振り返りサマリーを更新
            updateReviewSummary();
        }

        // 新しい項目を追加する関数
        function addNewItem() {
            const newItemName = document.getElementById('new-item-name').value.trim();
            const itemType = document.querySelector('input[name="item-type"]:checked').value;
            
            if (!newItemName) {
                alert('項目名を入力してください。');
                return;
            }
            
            // 既存の項目名と重複チェック
            const exists = itemsList.some(item => item.name === newItemName && item.type === itemType);
            if (exists) {
                alert('同じ項目名が既に存在します。');
                return;
            }
            
            // 新しい項目を追加（最後の順序番号+1）
            const sameTypeItems = itemsList.filter(item => item.type === itemType);
            const maxOrder = sameTypeItems.length > 0 ? Math.max(...sameTypeItems.map(item => item.order || 0)) : -1;
            
            itemsList.push({
                name: newItemName,
                type: itemType,
                order: maxOrder + 1
            });
            
            // データを保存
            saveDataToStorage();
            
            // UI更新
            updateItemsList();
            updateItemSelect();
            
            // 入力欄をクリア
            document.getElementById('new-item-name').value = '';
            
            alert('項目を追加しました！');
        }
        
        // 項目一覧を更新する関数
        function updateItemsList() {
            const itemType = document.querySelector('input[name="item-type"]:checked').value;
            const itemsListContainer = document.getElementById('items-list');
            
            // 現在選択されている種別の項目をフィルタしてorder順でソート
            const filteredItems = itemsList.filter(item => item.type === itemType)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            if (filteredItems.length === 0) {
                itemsListContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">項目がありません</p>';
                return;
            }
            
            // 項目一覧を表示
            itemsListContainer.innerHTML = filteredItems.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="color: ${item.type === 'income' ? '#28a745' : '#dc3545'};">
                        ${item.type === 'income' ? '💰' : '💸'} ${item.name}
                    </span>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="moveItem('${item.name}', '${item.type}', 'up')" 
                                ${index === 0 ? 'disabled' : ''} 
                                style="background-color: #6c757d; color: white; border: none; padding: 4px 6px; border-radius: 4px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'}; font-size: 0.7rem; opacity: ${index === 0 ? '0.5' : '1'};">↑</button>
                        <button onclick="moveItem('${item.name}', '${item.type}', 'down')" 
                                ${index === filteredItems.length - 1 ? 'disabled' : ''} 
                                style="background-color: #6c757d; color: white; border: none; padding: 4px 6px; border-radius: 4px; cursor: ${index === filteredItems.length - 1 ? 'not-allowed' : 'pointer'}; font-size: 0.7rem; opacity: ${index === filteredItems.length - 1 ? '0.5' : '1'};">↓</button>
                        <button onclick="deleteItem('${item.name}', '${item.type}')" style="background-color: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">削除</button>
                    </div>
                </div>
            `).join('');
        }

        // 項目を削除する関数
        function deleteItem(itemName, itemType) {
            // 使用中の項目かチェック
            const isInUse = expenses.some(expense => expense.item === itemName);
            
            if (isInUse) {
                if (!confirm(`「${itemName}」は収支記録で使用されています。削除すると記録が「未設定」となりますが、よろしいですか？`)) {
                    return;
                }
            } else {
                if (!confirm(`「${itemName}」を削除してもよろしいですか？`)) {
                    return;
                }
            }
            
            // 項目を削除
            itemsList = itemsList.filter(item => !(item.name === itemName && item.type === itemType));
            
            // データを保存
            saveDataToStorage();
            
            // UI更新
            updateItemsList();
            updateItemSelect();
            
            alert('項目を削除しました！');
        }

        // 項目を上下に移動する関数
        function moveItem(itemName, itemType, direction) {
            // 該当タイプの項目を取得してorder順でソート
            const sameTypeItems = itemsList.filter(item => item.type === itemType)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            // 移動対象の項目のインデックスを取得
            const currentIndex = sameTypeItems.findIndex(item => item.name === itemName);
            
            if (currentIndex === -1) return;
            
            let newIndex;
            if (direction === 'up' && currentIndex > 0) {
                newIndex = currentIndex - 1;
            } else if (direction === 'down' && currentIndex < sameTypeItems.length - 1) {
                newIndex = currentIndex + 1;
            } else {
                return; // 移動できない場合
            }
            
            // order値を交換
            const currentItem = sameTypeItems[currentIndex];
            const targetItem = sameTypeItems[newIndex];
            
            const tempOrder = currentItem.order;
            currentItem.order = targetItem.order;
            targetItem.order = tempOrder;
            
            // データを保存
            saveDataToStorage();
            
            // UI更新
            updateItemsList();
            updateItemSelect();
        }

        // 初期項目データを設定する関数
        function initializeDefaultItems() {
            itemsList = [
                // 支出項目
                { name: '食費', type: 'expense', order: 0 },
                { name: '交通費', type: 'expense', order: 1 },
                { name: '光熱費', type: 'expense', order: 2 },
                { name: '通信費', type: 'expense', order: 3 },
                { name: '医療費', type: 'expense', order: 4 },
                { name: '日用品', type: 'expense', order: 5 },
                { name: '衣服・美容', type: 'expense', order: 6 },
                { name: '娯楽費', type: 'expense', order: 7 },
                { name: '教育費', type: 'expense', order: 8 },
                { name: 'その他支出', type: 'expense', order: 9 },
                // 収入項目
                { name: '給料', type: 'income', order: 0 },
                { name: 'ボーナス', type: 'income', order: 1 },
                { name: '副収入', type: 'income', order: 2 },
                { name: '投資収益', type: 'income', order: 3 },
                { name: 'その他収入', type: 'income', order: 4 }
            ];
            saveDataToStorage();
        }

        // 既存データに順序情報を初期化する関数
        function initializeOrderForExistingItems() {
            let needsSave = false;
            ['expense', 'income'].forEach(type => {
                const items = itemsList.filter(item => item.type === type);
                items.forEach((item, index) => {
                    if (item.order === undefined) {
                        item.order = index;
                        needsSave = true;
                    }
                });
            });
            
            if (needsSave) {
                saveDataToStorage();
            }
        }

        // 項目セレクトボックスを更新する関数
        function updateItemSelect() {
            const itemSelect = document.getElementById('item');
            const currentType = document.querySelector('input[name="type"]:checked').value;
            
            // 一旦全ての選択肢をクリア
            itemSelect.innerHTML = '<option value="">項目を選択してください</option>';
            
            // 現在選択されている種別に対応する項目をorder順でソートして表示
            const filteredItems = itemsList.filter(item => item.type === currentType)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            filteredItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                itemSelect.appendChild(option);
            });
        }

        // フォームの送信イベントを処理
        document.getElementById('expense-form').addEventListener('submit', function(e) {
            e.preventDefault(); // ページのリロードを防ぐ

            // フォームから値を取得
            const item = document.getElementById('item').value.trim();
            const amount = parseInt(document.getElementById('amount').value);
            const date = document.getElementById('date').value;
            const type = document.querySelector('input[name="type"]:checked').value;
            const memo = document.getElementById('memo').value.trim();

            // 入力値の検証
            if (!item || !amount || !date) {
                alert('すべての項目を入力してください。');
                return;
            }

            if (amount < 0) {
                alert('金額にマイナス値は入力できません。');
                return;
            }

            if (editingExpenseId !== null) {
                // 編集モード: 既存のデータを更新
                const expenseIndex = expenses.findIndex(expense => expense.id === editingExpenseId);
                if (expenseIndex !== -1) {
                    expenses[expenseIndex] = {
                        id: editingExpenseId,
                        item: item,
                        amount: amount,
                        date: date,
                        type: type,
                        memo: memo
                    };
                    
                    // ローカルストレージに保存
                    saveDataToStorage();
                    
                    // フィルタリングしてテーブルを再描画
                    filterAndRenderRecords();
                    
                    // 編集モードを終了
                    exitEditMode();
                    
                    alert('記録が更新されました！');
                }
            } else {
                // 新規追加モード
                const newExpense = {
                    id: Date.now(), // 一意のIDを生成
                    item: item,
                    amount: amount,
                    date: date,
                    type: type,
                    memo: memo
                };
                expenses.push(newExpense);

                // ローカルストレージに保存
                saveDataToStorage();

                // フィルタリングしてテーブルを更新
                filterAndRenderRecords();

                // フォームをクリア
                clearForm();
            }
        });

        // 予算を設定する関数
        function setBudget() {
            const budgetInput = document.getElementById('budget');
            const budgetValue = parseInt(budgetInput.value);

            if (!budgetValue || budgetValue < 0) {
                alert('正しい金額を入力してください。');
                return;
            }

            monthlyBudget = budgetValue;
            saveDataToStorage();
            updateBudgetDisplay();
            updateRemaining();
            
            alert('予算が設定されました！');
        }

        // 予算表示を更新する関数
        function updateBudgetDisplay() {
            document.getElementById('budget-amount').textContent = `¥${monthlyBudget.toLocaleString()}`;
        }

        // 利用可能残高を更新する関数
        function updateRemaining() {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remaining = monthlyBudget - total;
            
            const remainingElement = document.getElementById('remaining-amount');
            remainingElement.textContent = `¥${remaining.toLocaleString()}`;
            
            // 残高がマイナスの場合は赤色で表示
            if (remaining < 0) {
                remainingElement.classList.add('negative');
            } else {
                remainingElement.classList.remove('negative');
            }
        }

        // テーブルに新しい行を追加する関数
        function addExpenseToTable(expense) {
            const tbody = document.getElementById('expense-tbody');

            // 初回追加時は空メッセージを削除
            if (expenses.length === 1) {
                tbody.innerHTML = '';
            }

            // 新しい行を作成
            const row = document.createElement('tr');
            const expenseType = expense.type || 'expense'; // 既存データ対応
            const typeDisplay = expenseType === 'income' ? '💰 収入' : '💸 支出';
            const typeColor = expenseType === 'income' ? '#28a745' : '#dc3545';
            const amountColor = expenseType === 'income' ? '#28a745' : '#dc3545';
            
            row.innerHTML = `
                <td data-label="日付">${expense.date}</td>
                <td data-label="種別" style="color: ${typeColor}; font-weight: 600;">${typeDisplay}</td>
                <td data-label="項目">${expense.item}</td>
                <td data-label="金額" style="color: ${amountColor}; font-weight: 600;">${expenseType === 'income' ? '+' : '-'}¥${expense.amount.toLocaleString()}</td>
                <td data-label="備考" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${expense.memo || ''}">${expense.memo || '-'}</td>
                <td data-label="操作" style="display: flex; gap: 5px;"></td>
            `;

            // 編集ボタンを作成
            const editButton = document.createElement('button');
            editButton.textContent = '編集';
            editButton.style.cssText = 'background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 5px;';
            editButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                editExpense(expense.id);
            });
            
            // 削除ボタンを個別に作成してイベントリスナーを設定
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '削除';
            deleteButton.style.cssText = 'background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;';
            deleteButton.addEventListener('click', function(e) {
                console.log('削除ボタンがクリックされました！対象ID:', expense.id);
                e.preventDefault();
                e.stopPropagation();
                deleteExpense(expense.id);
            });
            
            row.cells[5].appendChild(editButton);
            row.cells[5].appendChild(deleteButton);
            tbody.appendChild(row);
        }

        // フォームをクリアする関数
        function clearForm() {
            document.getElementById('item').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('date').valueAsDate = new Date(); // 今日の日付にリセット
            document.getElementById('memo').value = ''; // 備考欄もクリア
            document.getElementById('type-expense').checked = true; // デフォルトで支出を選択
            updateItemSelect(); // 項目セレクトボックスを更新
        }

        // 合計を更新する関数
        function updateTotal() {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('total-amount').textContent = `¥${total.toLocaleString()}`;
        }

        // 支出を削除する関数
        function deleteExpense(id) {
            console.log('deleteExpense関数が呼ばれました。削除対象ID:', id);
            console.log('現在のexpenses配列:', expenses);
            
            if (confirm('この記録を削除してもよろしいですか？')) {
                // 削除前の配列の長さ
                const beforeLength = expenses.length;
                
                // 配列から該当のデータを削除
                expenses = expenses.filter(expense => expense.id !== id);
                
                console.log('削除後のexpenses配列:', expenses);
                console.log('削除前の長さ:', beforeLength, '削除後の長さ:', expenses.length);

                // ローカルストレージを更新
                saveDataToStorage();

                // フィルタリングしてテーブルを再描画
                filterAndRenderRecords();
                
                //alert('削除が完了しました！');
            }
        }


        // 指定されたデータでテーブルを描画する関数（元のredrawTable関数を修正）
        function renderRecords(dataToRender) {
            const tbody = document.getElementById('expense-tbody');

            if (dataToRender.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-message">
                            該当するデータがありません。<br>
                            条件を変更するか、新しい記録を追加してみましょう！
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = '';
                dataToRender.forEach(expense => {
                    const row = document.createElement('tr');
                    const expenseType = expense.type || 'expense'; // 既存データ対応
                    const typeDisplay = expenseType === 'income' ? '💰 収入' : '💸 支出';
                    const typeColor = expenseType === 'income' ? '#28a745' : '#dc3545';
                    const amountColor = expenseType === 'income' ? '#28a745' : '#dc3545';
                    
                    row.innerHTML = `
                        <td data-label="日付">${expense.date}</td>
                        <td data-label="種別" style="color: ${typeColor}; font-weight: 600;">${typeDisplay}</td>
                        <td data-label="項目">${expense.item}</td>
                        <td data-label="金額" style="color: ${amountColor}; font-weight: 600;">${expenseType === 'income' ? '+' : '-'}¥${expense.amount.toLocaleString()}</td>
                        <td data-label="備考" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${expense.memo || ''}">${expense.memo || '-'}</td>
                        <td data-label="操作" style="display: flex; gap: 5px;"></td>
                    `;
                    
                    // 編集ボタンを作成
                    const editButton = document.createElement('button');
                    editButton.textContent = '編集';
                    editButton.style.cssText = 'background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 5px;';
                    editButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        editExpense(expense.id);
                    });
                    
                    // 削除ボタンを個別に作成してイベントリスナーを設定
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = '削除';
                    deleteButton.style.cssText = 'background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;';
                    deleteButton.addEventListener('click', function(e) {
                        console.log('削除ボタンがクリックされました！対象ID:', expense.id);
                        e.preventDefault();
                        e.stopPropagation();
                        deleteExpense(expense.id);
                    });
                    
                    row.cells[5].appendChild(editButton);
                    row.cells[5].appendChild(deleteButton);
                    tbody.appendChild(row);
                });
            }
        }

        // 支出を編集する関数
        function editExpense(id) {
            console.log('編集モードに入りました。対象ID:', id);
            
            // 編集対象のデータを検索
            const expense = expenses.find(exp => exp.id === id);
            if (!expense) {
                alert('編集対象のデータが見つかりません。');
                return;
            }
            
            // 編集モードに設定
            editingExpenseId = id;
            
            // フォームに既存データを読み込み
            document.getElementById('amount').value = expense.amount;
            document.getElementById('date').value = expense.date;
            document.getElementById('memo').value = expense.memo || '';
            
            // 種別を設定（既存データに種別がない場合はデフォルトで支出）
            const typeValue = expense.type || 'expense';
            document.querySelector(`input[name="type"][value="${typeValue}"]`).checked = true;
            
            // 項目セレクトボックスを更新してから項目を選択
            updateItemSelect();
            document.getElementById('item').value = expense.item;
            
            // ボタンのテキストを「更新」に変更
            document.getElementById('submit-button').textContent = '記録を更新';
            
            // フォームまでスクロール
            document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 編集モードを終了する関数
        function exitEditMode() {
            editingExpenseId = null;
            document.getElementById('submit-button').textContent = '記録を追加';
            clearForm();
        }

        // 年セレクトボックスを初期化する関数
        function initializeYearSelect() {
            const yearSelect = document.getElementById('year-select');
            const currentYear = new Date().getFullYear();
            
            // 現在年から過去3年、未来1年の範囲でオプションを生成
            const startYear = currentYear - 3;
            const endYear = currentYear + 1;
            
            // 「全ての年」オプションを追加
            const allYearOption = document.createElement('option');
            allYearOption.value = '';
            allYearOption.textContent = '全ての年';
            yearSelect.appendChild(allYearOption);
            
            // 年のオプションを追加（新しい年から順に）
            for (let year = endYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year + '年';
                yearSelect.appendChild(option);
            }
        }
        
        // 現在の年月を選択する関数
        function setCurrentYearMonth() {
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            
            document.getElementById('year-select').value = currentYear;
            document.getElementById('month-select').value = currentMonth;
        }
        
        // データをフィルタリングしてテーブルを更新する関数
        function filterAndRenderRecords() {
            const selectedYear = document.getElementById('year-select').value;
            const selectedMonth = document.getElementById('month-select').value;
            
            let filteredData = expenses;
            
            // 年でフィルタリング
            if (selectedYear) {
                filteredData = filteredData.filter(expense => {
                    const expenseYear = expense.date.split('-')[0];
                    return expenseYear === selectedYear;
                });
            }
            
            // 月でフィルタリング
            if (selectedMonth) {
                filteredData = filteredData.filter(expense => {
                    const expenseMonth = expense.date.split('-')[1];
                    return expenseMonth === selectedMonth;
                });
            }
            
            // 日付で並び替え
            filteredData.sort((a, b) => {
                if (sortOrder === 'desc') {
                    return new Date(b.date) - new Date(a.date); // 新→古
                } else {
                    return new Date(a.date) - new Date(b.date); // 古→新
                }
            });
            
            // フィルタリング・並び替えされたデータでテーブルを描画
            renderRecords(filteredData);
            
            // フィルタリングされたデータで合計と残高を更新
            updateTotalWithFilteredData(filteredData);
        }
        
        // 並び替え順序を切り替える関数
        function toggleSort() {
            if (sortOrder === 'desc') {
                sortOrder = 'asc';
                document.getElementById('sort-button').innerHTML = '📅 日付 (古→新)';
            } else {
                sortOrder = 'desc';
                document.getElementById('sort-button').innerHTML = '📅 日付 (新→古)';
            }
            
            // 現在のフィルター条件で再描画
            filterAndRenderRecords();
        }
        
        // フィルタリングされたデータで合計を更新する関数
        function updateTotalWithFilteredData(filteredData) {
            // 収入と支出を分けて計算
            const income = filteredData
                .filter(expense => expense.type === 'income')
                .reduce((sum, expense) => sum + expense.amount, 0);
            
            const expenses = filteredData
                .filter(expense => (expense.type || 'expense') === 'expense')
                .reduce((sum, expense) => sum + expense.amount, 0);
            
            const total = income - expenses; // 収入から支出を引いた実質的な収支
            
            // 収入・支出をそれぞれ表示
            document.getElementById('income-amount').textContent = `¥${income.toLocaleString()}`;
            document.getElementById('expense-amount').textContent = `¥${expenses.toLocaleString()}`;
            
            // 残高を更新（予算は全体のものを使用、支出のみで計算）
            const remaining = monthlyBudget - expenses;
            const remainingElement = document.getElementById('remaining-amount');
            remainingElement.textContent = `¥${remaining.toLocaleString()}`;
            
            // 残高がマイナスの場合は赤色で表示
            if (remaining < 0) {
                remainingElement.classList.add('negative');
            } else {
                remainingElement.classList.remove('negative');
            }
        }
        
        // セレクトボックスのイベントリスナーを設定する関数
        function setupFilterEventListeners() {
            document.getElementById('year-select').addEventListener('change', function() {
                filterAndRenderRecords();
                updateReviewSummary();
            });
            document.getElementById('month-select').addEventListener('change', function() {
                filterAndRenderRecords();
                updateReviewSummary();
            });
        }

        // 月次振り返り機能の変数
        let currentReviewType = null; // 'best' or 'worst'
        let selectedExpenses = []; // 選択された支出のID配列

        // ベスト・ワースト選択画面を表示
        function showBestWorstSelection(type) {
            currentReviewType = type;
            selectedExpenses = [];
            
            const currentYear = document.getElementById('year-select').value || new Date().getFullYear().toString();
            const currentMonth = document.getElementById('month-select').value || (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            // 選択された年月の支出データを取得（支出のみ）
            const monthlyExpenses = expenses.filter(expense => {
                const expenseYear = expense.date.split('-')[0];
                const expenseMonth = expense.date.split('-')[1];
                return expenseYear === currentYear && expenseMonth === currentMonth && (expense.type || 'expense') === 'expense';
            });

            if (monthlyExpenses.length === 0) {
                alert(`${currentYear}年${parseInt(currentMonth)}月の支出データがありません。`);
                return;
            }

            // UIを更新
            const title = type === 'best' ? '⭐ 今月のベスト支出を選択（最大3つ）' : '⚠️ 今月のワースト支出を選択（最大3つ）';
            document.getElementById('selection-title').textContent = title;
            
            // 支出リストを表示
            displayExpenseSelectionList(monthlyExpenses, currentYear, currentMonth);
            
            // 選択エリアを表示
            document.getElementById('review-selection-area').style.display = 'block';
            
            // 既存の選択データがあればロード
            loadExistingReviewData(currentYear, currentMonth, type);
        }

        // 支出選択リストを表示
        function displayExpenseSelectionList(monthlyExpenses, year, month) {
            const listContainer = document.getElementById('expense-selection-list');
            
            listContainer.innerHTML = monthlyExpenses.map(expense => `
                <div style="display: flex; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; background-color: #fafafa;">
                    <input type="checkbox" id="expense-${expense.id}" value="${expense.id}" 
                           onchange="toggleExpenseSelection(${expense.id})"
                           style="margin-right: 12px; transform: scale(1.2);">
                    <label for="expense-${expense.id}" style="flex: 1; cursor: pointer; margin-bottom: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${expense.item}</strong>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 2px;">
                                    ${expense.date} ${expense.memo ? `• ${expense.memo}` : ''}
                                </div>
                            </div>
                            <div style="font-weight: bold; color: #dc3545;">
                                ¥${expense.amount.toLocaleString()}
                            </div>
                        </div>
                    </label>
                </div>
            `).join('');
        }

        // 支出選択のトグル処理
        function toggleExpenseSelection(expenseId) {
            const checkbox = document.getElementById(`expense-${expenseId}`);
            
            if (checkbox.checked) {
                if (selectedExpenses.length >= 3) {
                    checkbox.checked = false;
                    alert('最大3つまで選択できます。');
                    return;
                }
                selectedExpenses.push(expenseId);
            } else {
                selectedExpenses = selectedExpenses.filter(id => id !== expenseId);
            }
            
            updateSelectedItemsArea();
        }

        // 選択された項目の表示エリアを更新
        function updateSelectedItemsArea() {
            const selectedItemsArea = document.getElementById('selected-items-area');
            
            if (selectedExpenses.length === 0) {
                selectedItemsArea.style.display = 'none';
                return;
            }
            
            selectedItemsArea.style.display = 'block';
            const typeText = currentReviewType === 'best' ? 'ベスト' : 'ワースト';
            
            selectedItemsArea.innerHTML = `
                <h4 style="color: #4a90e2; margin-bottom: 15px;">選択した${typeText}支出（${selectedExpenses.length}/3）</h4>
                ${selectedExpenses.map(expenseId => {
                    const expense = expenses.find(exp => exp.id === expenseId);
                    return `
                        <div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; background-color: #f9f9f9;">
                            <div style="font-weight: bold; margin-bottom: 8px;">
                                ${expense.item} - ¥${expense.amount.toLocaleString()}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="font-weight: 600; margin-bottom: 5px; display: block;">
                                    選んだ理由:
                                </label>
                                <textarea id="reason-${expenseId}" rows="3" placeholder="${currentReviewType === 'best' ? '例：長く使えるものを買えた、素晴らしい体験ができた など' : '例：衝動買いだった、もっと安く済ませられた など'}" 
                                          style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-family: inherit; resize: vertical;">${getExistingReason(expenseId) || ''}</textarea>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // 既存の振り返りデータをロード
        function loadExistingReviewData(year, month, type) {
            const reviewKey = `${year}-${month}`;
            const existingReview = monthlyReviews[reviewKey];
            
            if (existingReview && existingReview[type]) {
                selectedExpenses = existingReview[type].map(item => item.expenseId);
                
                // チェックボックスを更新
                selectedExpenses.forEach(expenseId => {
                    const checkbox = document.getElementById(`expense-${expenseId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                
                updateSelectedItemsArea();
            }
        }

        // 既存の理由を取得
        function getExistingReason(expenseId) {
            const currentYear = document.getElementById('year-select').value || new Date().getFullYear().toString();
            const currentMonth = document.getElementById('month-select').value || (new Date().getMonth() + 1).toString().padStart(2, '0');
            const reviewKey = `${currentYear}-${currentMonth}`;
            const existingReview = monthlyReviews[reviewKey];
            
            if (existingReview && existingReview[currentReviewType]) {
                const item = existingReview[currentReviewType].find(item => item.expenseId === expenseId);
                return item ? item.reason : '';
            }
            return '';
        }

        // 月次振り返りを保存
        function saveMonthlyReview() {
            if (selectedExpenses.length === 0) {
                alert('少なくとも1つの支出を選択してください。');
                return;
            }

            const currentYear = document.getElementById('year-select').value || new Date().getFullYear().toString();
            const currentMonth = document.getElementById('month-select').value || (new Date().getMonth() + 1).toString().padStart(2, '0');
            const reviewKey = `${currentYear}-${currentMonth}`;
            
            // 理由を収集
            const reviewItems = selectedExpenses.map(expenseId => {
                const expense = expenses.find(exp => exp.id === expenseId);
                const reasonTextarea = document.getElementById(`reason-${expenseId}`);
                const reason = reasonTextarea ? reasonTextarea.value.trim() : '';
                
                return {
                    expenseId: expenseId,
                    item: expense.item,
                    amount: expense.amount,
                    date: expense.date,
                    memo: expense.memo || '',
                    reason: reason
                };
            });
            
            // 月次振り返りデータを保存
            if (!monthlyReviews[reviewKey]) {
                monthlyReviews[reviewKey] = {};
            }
            monthlyReviews[reviewKey][currentReviewType] = reviewItems;
            
            // ローカルストレージに保存
            saveDataToStorage();
            
            // UI更新
            cancelSelection();
            updateReviewSummary();
            
            const typeText = currentReviewType === 'best' ? 'ベスト' : 'ワースト';
            alert(`${typeText}支出の振り返りを保存しました！`);
        }

        // 選択をキャンセル
        function cancelSelection() {
            document.getElementById('review-selection-area').style.display = 'none';
            currentReviewType = null;
            selectedExpenses = [];
        }

        // 振り返りサマリーを更新
        function updateReviewSummary() {
            const currentYear = document.getElementById('year-select').value || new Date().getFullYear().toString();
            const currentMonth = document.getElementById('month-select').value || (new Date().getMonth() + 1).toString().padStart(2, '0');
            const reviewKey = `${currentYear}-${currentMonth}`;
            const review = monthlyReviews[reviewKey];
            
            const summaryContent = document.getElementById('review-summary-content');
            
            if (!review || (!review.best && !review.worst)) {
                summaryContent.innerHTML = `
                    <p style="color: #888; text-align: center; font-style: italic;">
                        ${currentYear}年${parseInt(currentMonth)}月の振り返りデータがありません。<br>
                        上のボタンから今月のベスト・ワースト支出を選んでみましょう！
                    </p>
                `;
                return;
            }
            
            let html = `<h4 style="color: #666; margin-bottom: 15px;">${currentYear}年${parseInt(currentMonth)}月の振り返り</h4>`;
            
            if (review.best && review.best.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h5 style="color: #28a745; margin-bottom: 10px; display: flex; align-items: center;">
                            ⭐ ベスト支出 (${review.best.length}件)
                        </h5>
                        ${review.best.map((item, index) => `
                            <div style="background-color: #f8fff8; border-left: 4px solid #28a745; padding: 12px; margin-bottom: 10px; border-radius: 0 6px 6px 0;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                    ${index + 1}. ${item.item} - ¥${item.amount.toLocaleString()}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                                    ${item.date} ${item.memo ? `• ${item.memo}` : ''}
                                </div>
                                <div style="font-size: 0.9rem; color: #555; background-color: white; padding: 8px; border-radius: 4px; border: 1px solid #e0e0e0;">
                                    <strong>理由:</strong> ${item.reason || '（理由が記録されていません）'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (review.worst && review.worst.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h5 style="color: #dc3545; margin-bottom: 10px; display: flex; align-items: center;">
                            ⚠️ ワースト支出 (${review.worst.length}件)
                        </h5>
                        ${review.worst.map((item, index) => `
                            <div style="background-color: #fff8f8; border-left: 4px solid #dc3545; padding: 12px; margin-bottom: 10px; border-radius: 0 6px 6px 0;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                    ${index + 1}. ${item.item} - ¥${item.amount.toLocaleString()}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                                    ${item.date} ${item.memo ? `• ${item.memo}` : ''}
                                </div>
                                <div style="font-size: 0.9rem; color: #555; background-color: white; padding: 8px; border-radius: 4px; border: 1px solid #e0e0e0;">
                                    <strong>理由:</strong> ${item.reason || '（理由が記録されていません）'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            summaryContent.innerHTML = html;
        }

        // ページが読み込まれたときに初期化処理を実行
        document.addEventListener('DOMContentLoaded', initializeApp);

        // PWA対応: Service Worker登録
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                const swCode = `
                    const CACHE_NAME = 'kakeibo-app-v1';
                    const urlsToCache = [
                        '/',
                        '/index.html'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorker登録成功:', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker登録失敗:', err);
                    });
            });
        }

        // PWAインストール促進
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // インストールバナーを表示（オプション）
            const installButton = document.createElement('button');
            installButton.textContent = '📱 ホーム画面に追加';
            installButton.className = 'btn';
            installButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; background-color: #28a745; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';
            
            installButton.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWAインストール承諾');
                    }
                    deferredPrompt = null;
                    document.body.removeChild(installButton);
                });
            });
            
            document.body.appendChild(installButton);
            
            // 3秒後に自動で非表示
            setTimeout(() => {
                if (document.body.contains(installButton)) {
                    document.body.removeChild(installButton);
                }
            }, 5000);
        });
    </script>
</body>
</html>