<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å®¶è¨ˆç°¿">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="ã‚·ãƒ³ãƒ—ãƒ«ã§ä½¿ã„ã‚„ã™ã„å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª">
    <title>å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª</title>
    
    <!-- PWAç”¨ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWuteioreexv+OCouODl+ODqiIsCiAgInNob3J0X25hbWUiOiAi5a616KiI56C/IiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjVmNWY1IiwKICAidGhlbWVfY29sb3IiOiAiIzRhOTBlMiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBeU9EZ2lJR1pwYkd3OUluVnliQ2doSXpkcUlpQjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBpQXZQZ289IiwKICAgICAgInNpemVzIjogImFueSIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    
    <!-- iOSç”¨ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAyODgiIGZpbGw9InVybCgjN2opIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPiA8L3N2Zz4K">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #4a90e2;
            color: white;
            text-align: center;
            padding: 30px 0;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-section h2 {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #357abd;
        }

        .data-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .data-section h2 {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        .budget-section {
            background-color: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .budget-section h2 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .budget-form {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .budget-form label {
            font-weight: 600;
            color: #856404;
            white-space: nowrap;
        }

        .budget-form input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ffeaa7;
            border-radius: 6px;
            font-size: 1rem;
        }

        .budget-form input:focus {
            outline: none;
            border-color: #fdcb6e;
        }

        .summary {
            background-color: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            gap: 20px;
            justify-content: space-between;
        }

        .summary-item {
            flex: 1;
            text-align: center;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .summary-item h3 {
            color: #4a90e2;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .summary-item .amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .summary-item:last-child .amount {
            color: #28a745;
        }

        .summary-item:last-child .amount.negative {
            color: #dc3545;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 20px 0;
                margin-bottom: 20px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .form-section, .data-section {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .budget-form {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .budget-form label {
                text-align: left;
                margin-bottom: 5px;
            }

            .summary-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .summary-item {
                padding: 12px;
            }
            
            .summary-item h3 {
                font-size: 0.9rem;
            }
            
            .summary-item .amount {
                font-size: 1.1rem;
            }
            
            /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¹ãƒãƒ›å‘ã‘ã«æœ€é©åŒ– */
            table {
                font-size: 0.8rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            thead, tbody, th, td, tr {
                display: block;
            }
            
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            tbody tr {
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                background: white;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                position: relative;
                display: block !important;
            }
            
            tbody td {
                border: none;
                position: relative;
                padding: 8px 0 8px 120px !important;
                text-align: left !important;
                white-space: normal;
                word-wrap: break-word;
            }
            
            tbody td:before {
                content: attr(data-label) ": ";
                position: absolute;
                left: 0;
                width: 110px;
                font-weight: bold;
                color: #555;
            }
            
            /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼éƒ¨åˆ† */
            .filter-section {
                flex-direction: column;
                gap: 10px;
                align-items: stretch !important;
            }
            
            .filter-section > div {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            /* é …ç›®ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
            .budget-section[style*="background-color: #f0f8ff"] > div:first-child > div:first-child {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .budget-section[style*="background-color: #f0f8ff"] > div:first-child > div:last-child {
                flex-direction: column;
                gap: 10px;
            }
            
            /* ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºã®èª¿æ•´ */
            .btn {
                padding: 15px 25px;
                font-size: 1.1rem;
                min-height: 50px;
                touch-action: manipulation;
            }
            
            /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®èª¿æ•´ */
            input, select, textarea {
                padding: 15px 12px !important;
                font-size: 1.1rem !important;
                min-height: 50px;
                border-radius: 8px;
            }
            
            textarea {
                min-height: 100px;
            }
            
            /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
            input[type="radio"] {
                width: 20px;
                height: 20px;
                margin-right: 10px;
            }
            
            /* æ“ä½œãƒœã‚¿ãƒ³ã®èª¿æ•´ */
            button {
                min-height: 44px;
                padding: 12px 16px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ’° å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒª</h1>
            <p class="subtitle">ã‚ãªãŸã®å®¶è¨ˆç®¡ç†ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™</p>
        </header>

        <div class="form-section">
            <h2>ğŸ“ åæ”¯ã®è¨˜éŒ²</h2>
            <form id="expense-form">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="margin-bottom: 10px; display: block;">ç¨®åˆ¥</label>
                    <div style="display: flex; gap: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                            <input type="radio" id="type-expense" name="type" value="expense" checked style="margin-right: 8px;">
                            <span style="color: #dc3545;">ğŸ’¸ æ”¯å‡º</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                            <input type="radio" id="type-income" name="type" value="income" style="margin-right: 8px;">
                            <span style="color: #28a745;">ğŸ’° åå…¥</span>
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="item">é …ç›®</label>
                        <select id="item" name="item" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease;">
                            <option value="">é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                            <!-- é …ç›®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">é‡‘é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="amount" name="amount" placeholder="ä¾‹ï¼š1500" min="0" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="date">æ—¥ä»˜</label>
                        <input type="date" id="date" name="date" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="memo">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="memo" name="memo" rows="3" placeholder="ä¾‹ï¼šã‚³ãƒ³ãƒ“ãƒ‹ã§æ˜¼é£Ÿã€äº¤é€šè²»ï¼ˆé›»è»Šä»£ï¼‰ã€ãƒœãƒ¼ãƒŠã‚¹æ”¯çµ¦ãªã©" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; transition: border-color 0.3s ease;"></textarea>
                </div>
                <button type="submit" class="btn" id="submit-button">è¨˜éŒ²ã‚’è¿½åŠ </button>
            </form>
        </div>

        <div class="data-section">
            <div class="budget-section">
                <h2>ğŸ’° äºˆç®—è¨­å®š</h2>
                <div class="budget-form">
                    <label for="budget">ä»Šæœˆã®åˆ©ç”¨å¯èƒ½é‡‘é¡ï¼ˆå††ï¼‰</label>
                    <input type="number" id="budget" min="0" step="1" placeholder="ä¾‹ï¼š50000">
                    <button onclick="setBudget()" class="btn" style="margin-left: 10px; padding: 8px 20px;">è¨­å®š</button>
                </div>
            </div>
            
            <div class="budget-section" style="background-color: #f0f8ff; border: 1px solid #4a90e2;">
                <h2>ğŸ“ é …ç›®ç®¡ç†</h2>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                            <input type="radio" name="item-type" value="expense" checked style="margin-right: 8px;">
                            <span style="color: #dc3545;">ğŸ’¸ æ”¯å‡ºé …ç›®</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 0;">
                            <input type="radio" name="item-type" value="income" style="margin-right: 8px;">
                            <span style="color: #28a745;">ğŸ’° åå…¥é …ç›®</span>
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="new-item-name" placeholder="æ–°ã—ã„é …ç›®å" style="flex: 1; padding: 8px 12px; border: 2px solid #4a90e2; border-radius: 6px; font-size: 1rem;">
                        <button onclick="addNewItem()" class="btn" style="padding: 8px 20px;">è¿½åŠ </button>
                    </div>
                </div>
                <div id="items-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: white;">
                    <!-- é …ç›®ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>

            <div class="summary">
                <div class="summary-row">
                    <div class="summary-item">
                        <h3>ä»Šæœˆã®åˆ©ç”¨å¯èƒ½é‡‘é¡</h3>
                        <div class="amount" id="budget-amount">Â¥0</div>
                    </div>
                    <div class="summary-item">
                        <h3>ä»Šæœˆã®åå…¥åˆè¨ˆ</h3>
                        <div class="amount" id="income-amount" style="color: #28a745;">Â¥0</div>
                    </div>
                    <div class="summary-item">
                        <h3>ä»Šæœˆã®æ”¯å‡ºåˆè¨ˆ</h3>
                        <div class="amount" id="expense-amount" style="color: #dc3545;">Â¥0</div>
                    </div>
                    <div class="summary-item">
                        <h3>åˆ©ç”¨å¯èƒ½æ®‹é«˜</h3>
                        <div class="amount" id="remaining-amount">Â¥0</div>
                    </div>
                </div>
            </div>
            
            <h2>ğŸ“Š åæ”¯ä¸€è¦§</h2>
            <div class="filter-section" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div>
                    <label for="year-select" style="margin-right: 8px; font-weight: 600;">å¹´ï¼š</label>
                    <select id="year-select" style="padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem;">
                        <!-- å¹´ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                </div>
                <div>
                    <label for="month-select" style="margin-right: 8px; font-weight: 600;">æœˆï¼š</label>
                    <select id="month-select" style="padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem;">
                        <option value="">å…¨ã¦ã®æœˆ</option>
                        <option value="01">1æœˆ</option>
                        <option value="02">2æœˆ</option>
                        <option value="03">3æœˆ</option>
                        <option value="04">4æœˆ</option>
                        <option value="05">5æœˆ</option>
                        <option value="06">6æœˆ</option>
                        <option value="07">7æœˆ</option>
                        <option value="08">8æœˆ</option>
                        <option value="09">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                </div>
                <div>
                    <label style="margin-right: 8px; font-weight: 600;">ä¸¦ã³æ›¿ãˆï¼š</label>
                    <button id="sort-button" onclick="toggleSort()" class="btn" style="padding: 8px 16px; font-size: 0.9rem; background-color: #6c757d;">
                        ğŸ“… æ—¥ä»˜ (æ–°â†’å¤)
                    </button>
                </div>
            </div>
            <table id="expense-table">
                <thead>
                    <tr>
                        <th>æ—¥ä»˜</th>
                        <th>ç¨®åˆ¥</th>
                        <th>é …ç›®</th>
                        <th>é‡‘é¡</th>
                        <th>å‚™è€ƒ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="expense-tbody">
                    <tr>
                        <td colspan="6" class="empty-message">
                            ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                            ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰åæ”¯ã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="form-section" style="background-color: #fff9e6; border: 2px solid #ffd93d;">
            <h2 style="color: #b8860b;">ğŸ† ä»Šæœˆã®æŒ¯ã‚Šè¿”ã‚Š</h2>
            <div style="margin-bottom: 20px;">
                <p style="color: #8b7355; margin-bottom: 15px;">ä»Šæœˆã‚’æŒ¯ã‚Šè¿”ã£ã¦ã€ç‰¹ã«ä¾¡å€¤ãŒã‚ã£ãŸæ”¯å‡ºã¨æ”¹å–„ã—ãŸã„æ”¯å‡ºã‚’é¸ã‚“ã§ã¿ã¾ã—ã‚‡ã†ã€‚</p>
                
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <button onclick="showBestWorstSelection('best')" class="btn" style="background-color: #28a745; flex: 1;">
                        â­ ãƒ™ã‚¹ãƒˆæ”¯å‡ºã‚’é¸ã¶
                    </button>
                    <button onclick="showBestWorstSelection('worst')" class="btn" style="background-color: #dc3545; flex: 1;">
                        âš ï¸ ãƒ¯ãƒ¼ã‚¹ãƒˆæ”¯å‡ºã‚’é¸ã¶
                    </button>
                </div>
                
                <div id="review-selection-area" style="display: none; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background-color: white; margin-bottom: 20px;">
                    <h3 id="selection-title" style="margin-bottom: 15px; color: #4a90e2;"></h3>
                    <div id="expense-selection-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
                    <div id="selected-items-area" style="display: none; margin-top: 20px;"></div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                        <button onclick="saveMonthlyReview()" class="btn" style="background-color: #28a745;">ä¿å­˜</button>
                        <button onclick="cancelSelection()" class="btn" style="background-color: #6c757d;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
                
                <div id="review-summary" style="background-color: white; border-radius: 8px; padding: 20px; border: 1px solid #ddd;">
                    <h3 style="color: #4a90e2; margin-bottom: 15px;">ğŸ“Š æŒ¯ã‚Šè¿”ã‚Šã‚µãƒãƒªãƒ¼</h3>
                    <div id="review-summary-content">
                        <p style="color: #888; text-align: center; font-style: italic;">ã¾ã æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä»Šæœˆã®ãƒ™ã‚¹ãƒˆãƒ»ãƒ¯ãƒ¼ã‚¹ãƒˆæ”¯å‡ºã‚’é¸ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
        const STORAGE_KEY = 'kakeiboRecords';
        const BUDGET_KEY = 'kakeiboBudget';
        const ITEMS_KEY = 'kakeiboItems';
        const MONTHLY_REVIEW_KEY = 'kakeiboMonthlyReview';

        // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
        let expenses = [];
        let monthlyBudget = 0;
        let editingExpenseId = null; // ç·¨é›†ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ID
        let itemsList = []; // é …ç›®ãƒã‚¹ã‚¿
        let monthlyReviews = {}; // æœˆæ¬¡æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿
        let sortOrder = 'desc'; // ä¸¦ã³æ›¿ãˆé †åº: 'desc' (æ–°â†’å¤) or 'asc' (å¤â†’æ–°)

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        function loadDataFromStorage() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    expenses = JSON.parse(storedData);
                }
                
                const storedBudget = localStorage.getItem(BUDGET_KEY);
                if (storedBudget) {
                    monthlyBudget = parseInt(storedBudget);
                    document.getElementById('budget').value = monthlyBudget;
                }
                
                const storedItems = localStorage.getItem(ITEMS_KEY);
                if (storedItems) {
                    itemsList = JSON.parse(storedItems);
                    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«orderæƒ…å ±ãŒãªã„å ´åˆã¯è¿½åŠ 
                    initializeOrderForExistingItems();
                } else {
                    // åˆæœŸé …ç›®ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    initializeDefaultItems();
                }
                
                const storedReviews = localStorage.getItem(MONTHLY_REVIEW_KEY);
                if (storedReviews) {
                    monthlyReviews = JSON.parse(storedReviews);
                }
                
                return true;
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
            return false;
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
        function saveDataToStorage() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
                localStorage.setItem(BUDGET_KEY, monthlyBudget.toString());
                localStorage.setItem(ITEMS_KEY, JSON.stringify(itemsList));
                localStorage.setItem(MONTHLY_REVIEW_KEY, JSON.stringify(monthlyReviews));
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–å‡¦ç†
        function initializeApp() {
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¨­å®š
            document.getElementById('date').valueAsDate = new Date();

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            loadDataFromStorage();

            // å¹´ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
            initializeYearSelect();

            // ç¾åœ¨ã®å¹´æœˆã‚’é¸æŠ
            setCurrentYearMonth();

            // é …ç›®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            updateItemSelect();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
            filterAndRenderRecords();

            // äºˆç®—è¡¨ç¤ºã‚’æ›´æ–°
            updateBudgetDisplay();

            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupFilterEventListeners();
            
            // ç¨®åˆ¥å¤‰æ›´æ™‚ã«é …ç›®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
            document.querySelectorAll('input[name="type"]').forEach(radio => {
                radio.addEventListener('change', updateItemSelect);
            });
            
            // é …ç›®ç®¡ç†ã®ç¨®åˆ¥å¤‰æ›´æ™‚ã«é …ç›®ä¸€è¦§ã‚’æ›´æ–°
            document.querySelectorAll('input[name="item-type"]').forEach(radio => {
                radio.addEventListener('change', updateItemsList);
            });
            
            // é …ç›®ä¸€è¦§ã‚’åˆæœŸè¡¨ç¤º
            updateItemsList();
            
            // æœˆæ¬¡æŒ¯ã‚Šè¿”ã‚Šã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
            updateReviewSummary();
        }

        // æ–°ã—ã„é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addNewItem() {
            const newItemName = document.getElementById('new-item-name').value.trim();
            const itemType = document.querySelector('input[name="item-type"]:checked').value;
            
            if (!newItemName) {
                alert('é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // æ—¢å­˜ã®é …ç›®åã¨é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const exists = itemsList.some(item => item.name === newItemName && item.type === itemType);
            if (exists) {
                alert('åŒã˜é …ç›®åãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚');
                return;
            }
            
            // æ–°ã—ã„é …ç›®ã‚’è¿½åŠ ï¼ˆæœ€å¾Œã®é †åºç•ªå·+1ï¼‰
            const sameTypeItems = itemsList.filter(item => item.type === itemType);
            const maxOrder = sameTypeItems.length > 0 ? Math.max(...sameTypeItems.map(item => item.order || 0)) : -1;
            
            itemsList.push({
                name: newItemName,
                type: itemType,
                order: maxOrder + 1
            });
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveDataToStorage();
            
            // UIæ›´æ–°
            updateItemsList();
            updateItemSelect();
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('new-item-name').value = '';
            
            alert('é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼');
        }
        
        // é …ç›®ä¸€è¦§ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateItemsList() {
            const itemType = document.querySelector('input[name="item-type"]:checked').value;
            const itemsListContainer = document.getElementById('items-list');
            
            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ç¨®åˆ¥ã®é …ç›®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦orderé †ã§ã‚½ãƒ¼ãƒˆ
            const filteredItems = itemsList.filter(item => item.type === itemType)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            if (filteredItems.length === 0) {
                itemsListContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // é …ç›®ä¸€è¦§ã‚’è¡¨ç¤º
            itemsListContainer.innerHTML = filteredItems.map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span style="color: ${item.type === 'income' ? '#28a745' : '#dc3545'};">
                        ${item.type === 'income' ? 'ğŸ’°' : 'ğŸ’¸'} ${item.name}
                    </span>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="moveItem('${item.name}', '${item.type}', 'up')" 
                                ${index === 0 ? 'disabled' : ''} 
                                style="background-color: #6c757d; color: white; border: none; padding: 4px 6px; border-radius: 4px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'}; font-size: 0.7rem; opacity: ${index === 0 ? '0.5' : '1'};">â†‘</button>
                        <button onclick="moveItem('${item.name}', '${item.type}', 'down')" 
                                ${index === filteredItems.length - 1 ? 'disabled' : ''} 
                                style="background-color: #6c757d; color: white; border: none; padding: 4px 6px; border-radius: 4px; cursor: ${index === filteredItems.length - 1 ? 'not-allowed' : 'pointer'}; font-size: 0.7rem; opacity: ${index === filteredItems.length - 1 ? '0.5' : '1'};">â†“</button>
                        <button onclick="deleteItem('${item.name}', '${item.type}')" style="background-color: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // é …ç›®ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function deleteItem(itemName, itemType) {
            // ä½¿ç”¨ä¸­ã®é …ç›®ã‹ãƒã‚§ãƒƒã‚¯
            const isInUse = expenses.some(expense => expense.item === itemName);
            
            if (isInUse) {
                if (!confirm(`ã€Œ${itemName}ã€ã¯åæ”¯è¨˜éŒ²ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚å‰Šé™¤ã™ã‚‹ã¨è¨˜éŒ²ãŒã€Œæœªè¨­å®šã€ã¨ãªã‚Šã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    return;
                }
            } else {
                if (!confirm(`ã€Œ${itemName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    return;
                }
            }
            
            // é …ç›®ã‚’å‰Šé™¤
            itemsList = itemsList.filter(item => !(item.name === itemName && item.type === itemType));
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveDataToStorage();
            
            // UIæ›´æ–°
            updateItemsList();
            updateItemSelect();
            
            alert('é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼');
        }

        // é …ç›®ã‚’ä¸Šä¸‹ã«ç§»å‹•ã™ã‚‹é–¢æ•°
        function moveItem(itemName, itemType, direction) {
            // è©²å½“ã‚¿ã‚¤ãƒ—ã®é …ç›®ã‚’å–å¾—ã—ã¦orderé †ã§ã‚½ãƒ¼ãƒˆ
            const sameTypeItems = itemsList.filter(item => item.type === itemType)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            // ç§»å‹•å¯¾è±¡ã®é …ç›®ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            const currentIndex = sameTypeItems.findIndex(item => item.name === itemName);
            
            if (currentIndex === -1) return;
            
            let newIndex;
            if (direction === 'up' && currentIndex > 0) {
                newIndex = currentIndex - 1;
            } else if (direction === 'down' && currentIndex < sameTypeItems.length - 1) {
                newIndex = currentIndex + 1;
            } else {
                return; // ç§»å‹•ã§ããªã„å ´åˆ
            }
            
            // orderå€¤ã‚’äº¤æ›
            const currentItem = sameTypeItems[currentIndex];
            const targetItem = sameTypeItems[newIndex];
            
            const tempOrder = currentItem.order;
            currentItem.order = targetItem.order;
            targetItem.order = tempOrder;
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveDataToStorage();
            
            // UIæ›´æ–°
            updateItemsList();
            updateItemSelect();
        }

        // åˆæœŸé …ç›®ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹é–¢æ•°
        function initializeDefaultItems() {
            itemsList = [
                // æ”¯å‡ºé …ç›®
                { name: 'é£Ÿè²»', type: 'expense', order: 0 },
                { name: 'äº¤é€šè²»', type: 'expense', order: 1 },
                { name: 'å…‰ç†±è²»', type: 'expense', order: 2 },
                { name: 'é€šä¿¡è²»', type: 'expense', order: 3 },
                { name: 'åŒ»ç™‚è²»', type: 'expense', order: 4 },
                { name: 'æ—¥ç”¨å“', type: 'expense', order: 5 },
                { name: 'è¡£æœãƒ»ç¾å®¹', type: 'expense', order: 6 },
                { name: 'å¨¯æ¥½è²»', type: 'expense', order: 7 },
                { name: 'æ•™è‚²è²»', type: 'expense', order: 8 },
                { name: 'ãã®ä»–æ”¯å‡º', type: 'expense', order: 9 },
                // åå…¥é …ç›®
                { name: 'çµ¦æ–™', type: 'income', order: 0 },
                { name: 'ãƒœãƒ¼ãƒŠã‚¹', type: 'income', order: 1 },
                { name: 'å‰¯åå…¥', type: 'income', order: 2 },
                { name: 'æŠ•è³‡åç›Š', type: 'income', order: 3 },
                { name: 'ãã®ä»–åå…¥', type: 'income', order: 4 }
            ];
            saveDataToStorage();
        }

        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«é †åºæƒ…å ±ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
        function initializeOrderForExistingItems() {
            let needsSave = false;
            ['expense', 'income'].forEach(type => {
                const items = itemsList.filter(item => item.type === type);
                items.forEach((item, index) => {
                    if (item.order === undefined) {
                        item.order = index;
                        needsSave = true;
                    }
                });
            });
            
            if (needsSave) {
                saveDataToStorage();
            }
        }

        // é …ç›®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateItemSelect() {
            const itemSelect = document.getElementById('item');
            const currentType = document.querySelector('input[name="type"]:checked').value;
            
            // ä¸€æ—¦å…¨ã¦ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
            itemSelect.innerHTML = '<option value="">é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ç¨®åˆ¥ã«å¯¾å¿œã™ã‚‹é …ç›®ã‚’orderé †ã§ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
            const filteredItems = itemsList.filter(item => item.type === currentType)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            filteredItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                itemSelect.appendChild(option);
            });
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
        document.getElementById('expense-form').addEventListener('submit', function(e) {
            e.preventDefault(); // ãƒšãƒ¼ã‚¸ã®ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é˜²ã

            // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—
            const item = document.getElementById('item').value.trim();
            const amount = parseInt(document.getElementById('amount').value);
            const date = document.getElementById('date').value;
            const type = document.querySelector('input[name="type"]:checked').value;
            const memo = document.getElementById('memo').value.trim();

            // å…¥åŠ›å€¤ã®æ¤œè¨¼
            if (!item || !amount || !date) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (amount < 0) {
                alert('é‡‘é¡ã«ãƒã‚¤ãƒŠã‚¹å€¤ã¯å…¥åŠ›ã§ãã¾ã›ã‚“ã€‚');
                return;
            }

            if (editingExpenseId !== null) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                const expenseIndex = expenses.findIndex(expense => expense.id === editingExpenseId);
                if (expenseIndex !== -1) {
                    expenses[expenseIndex] = {
                        id: editingExpenseId,
                        item: item,
                        amount: amount,
                        date: date,
                        type: type,
                        memo: memo
                    };
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    saveDataToStorage();
                    
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
                    filterAndRenderRecords();
                    
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
                    exitEditMode();
                    
                    alert('è¨˜éŒ²ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼');
                }
            } else {
                // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰
                const newExpense = {
                    id: Date.now(), // ä¸€æ„ã®IDã‚’ç”Ÿæˆ
                    item: item,
                    amount: amount,
                    date: date,
                    type: type,
                    memo: memo
                };
                expenses.push(newExpense);

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                saveDataToStorage();

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
                filterAndRenderRecords();

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                clearForm();
            }
        });

        // äºˆç®—ã‚’è¨­å®šã™ã‚‹é–¢æ•°
        function setBudget() {
            const budgetInput = document.getElementById('budget');
            const budgetValue = parseInt(budgetInput.value);

            if (!budgetValue || budgetValue < 0) {
                alert('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            monthlyBudget = budgetValue;
            saveDataToStorage();
            updateBudgetDisplay();
            updateRemaining();
            
            alert('äºˆç®—ãŒè¨­å®šã•ã‚Œã¾ã—ãŸï¼');
        }

        // äºˆç®—è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateBudgetDisplay() {
            document.getElementById('budget-amount').textContent = `Â¥${monthlyBudget.toLocaleString()}`;
        }

        // åˆ©ç”¨å¯èƒ½æ®‹é«˜ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateRemaining() {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const remaining = monthlyBudget - total;
            
            const remainingElement = document.getElementById('remaining-amount');
            remainingElement.textContent = `Â¥${remaining.toLocaleString()}`;
            
            // æ®‹é«˜ãŒãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯èµ¤è‰²ã§è¡¨ç¤º
            if (remaining < 0) {
                remainingElement.classList.add('negative');
            } else {
                remainingElement.classList.remove('negative');
            }
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ–°ã—ã„è¡Œã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        function addExpenseToTable(expense) {
            const tbody = document.getElementById('expense-tbody');

            // åˆå›è¿½åŠ æ™‚ã¯ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            if (expenses.length === 1) {
                tbody.innerHTML = '';
            }

            // æ–°ã—ã„è¡Œã‚’ä½œæˆ
            const row = document.createElement('tr');
            const expenseType = expense.type || 'expense'; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
            const typeDisplay = expenseType === 'income' ? 'ğŸ’° åå…¥' : 'ğŸ’¸ æ”¯å‡º';
            const typeColor = expenseType === 'income' ? '#28a745' : '#dc3545';
            const amountColor = expenseType === 'income' ? '#28a745' : '#dc3545';
            
            row.innerHTML = `
                <td data-label="æ—¥ä»˜">${expense.date}</td>
                <td data-label="ç¨®åˆ¥" style="color: ${typeColor}; font-weight: 600;">${typeDisplay}</td>
                <td data-label="é …ç›®">${expense.item}</td>
                <td data-label="é‡‘é¡" style="color: ${amountColor}; font-weight: 600;">${expenseType === 'income' ? '+' : '-'}Â¥${expense.amount.toLocaleString()}</td>
                <td data-label="å‚™è€ƒ" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${expense.memo || ''}">${expense.memo || '-'}</td>
                <td data-label="æ“ä½œ" style="display: flex; gap: 5px;"></td>
            `;

            // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
            const editButton = document.createElement('button');
            editButton.textContent = 'ç·¨é›†';
            editButton.style.cssText = 'background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 5px;';
            editButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                editExpense(expense.id);
            });
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å€‹åˆ¥ã«ä½œæˆã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'å‰Šé™¤';
            deleteButton.style.cssText = 'background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;';
            deleteButton.addEventListener('click', function(e) {
                console.log('å‰Šé™¤ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼å¯¾è±¡ID:', expense.id);
                e.preventDefault();
                e.stopPropagation();
                deleteExpense(expense.id);
            });
            
            row.cells[5].appendChild(editButton);
            row.cells[5].appendChild(deleteButton);
            tbody.appendChild(row);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
        function clearForm() {
            document.getElementById('item').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('date').valueAsDate = new Date(); // ä»Šæ—¥ã®æ—¥ä»˜ã«ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('memo').value = ''; // å‚™è€ƒæ¬„ã‚‚ã‚¯ãƒªã‚¢
            document.getElementById('type-expense').checked = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ”¯å‡ºã‚’é¸æŠ
            updateItemSelect(); // é …ç›®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
        }

        // åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateTotal() {
            const total = expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('total-amount').textContent = `Â¥${total.toLocaleString()}`;
        }

        // æ”¯å‡ºã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function deleteExpense(id) {
            console.log('deleteExpenseé–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸã€‚å‰Šé™¤å¯¾è±¡ID:', id);
            console.log('ç¾åœ¨ã®expensesé…åˆ—:', expenses);
            
            if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                // å‰Šé™¤å‰ã®é…åˆ—ã®é•·ã•
                const beforeLength = expenses.length;
                
                // é…åˆ—ã‹ã‚‰è©²å½“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                expenses = expenses.filter(expense => expense.id !== id);
                
                console.log('å‰Šé™¤å¾Œã®expensesé…åˆ—:', expenses);
                console.log('å‰Šé™¤å‰ã®é•·ã•:', beforeLength, 'å‰Šé™¤å¾Œã®é•·ã•:', expenses.length);

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
                saveDataToStorage();

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
                filterAndRenderRecords();
                
                //alert('å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            }
        }


        // æŒ‡å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»ã™ã‚‹é–¢æ•°ï¼ˆå…ƒã®redrawTableé–¢æ•°ã‚’ä¿®æ­£ï¼‰
        function renderRecords(dataToRender) {
            const tbody = document.getElementById('expense-tbody');

            if (dataToRender.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-message">
                            è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                            æ¡ä»¶ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = '';
                dataToRender.forEach(expense => {
                    const row = document.createElement('tr');
                    const expenseType = expense.type || 'expense'; // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
                    const typeDisplay = expenseType === 'income' ? 'ğŸ’° åå…¥' : 'ğŸ’¸ æ”¯å‡º';
                    const typeColor = expenseType === 'income' ? '#28a745' : '#dc3545';
                    const amountColor = expenseType === 'income' ? '#28a745' : '#dc3545';
                    
                    row.innerHTML = `
                        <td data-label="æ—¥ä»˜">${expense.date}</td>
                        <td data-label="ç¨®åˆ¥" style="color: ${typeColor}; font-weight: 600;">${typeDisplay}</td>
                        <td data-label="é …ç›®">${expense.item}</td>
                        <td data-label="é‡‘é¡" style="color: ${amountColor}; font-weight: 600;">${expenseType === 'income' ? '+' : '-'}Â¥${expense.amount.toLocaleString()}</td>
                        <td data-label="å‚™è€ƒ" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${expense.memo || ''}">${expense.memo || '-'}</td>
                        <td data-label="æ“ä½œ" style="display: flex; gap: 5px;"></td>
                    `;
                    
                    // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
                    const editButton = document.createElement('button');
                    editButton.textContent = 'ç·¨é›†';
                    editButton.style.cssText = 'background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 5px;';
                    editButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        editExpense(expense.id);
                    });
                    
                    // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’å€‹åˆ¥ã«ä½œæˆã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'å‰Šé™¤';
                    deleteButton.style.cssText = 'background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;';
                    deleteButton.addEventListener('click', function(e) {
                        console.log('å‰Šé™¤ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸï¼å¯¾è±¡ID:', expense.id);
                        e.preventDefault();
                        e.stopPropagation();
                        deleteExpense(expense.id);
                    });
                    
                    row.cells[5].appendChild(editButton);
                    row.cells[5].appendChild(deleteButton);
                    tbody.appendChild(row);
                });
            }
        }

        // æ”¯å‡ºã‚’ç·¨é›†ã™ã‚‹é–¢æ•°
        function editExpense(id) {
            console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Šã¾ã—ãŸã€‚å¯¾è±¡ID:', id);
            
            // ç·¨é›†å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
            const expense = expenses.find(exp => exp.id === id);
            if (!expense) {
                alert('ç·¨é›†å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
            editingExpenseId = id;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            document.getElementById('amount').value = expense.amount;
            document.getElementById('date').value = expense.date;
            document.getElementById('memo').value = expense.memo || '';
            
            // ç¨®åˆ¥ã‚’è¨­å®šï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ç¨®åˆ¥ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ”¯å‡ºï¼‰
            const typeValue = expense.type || 'expense';
            document.querySelector(`input[name="type"][value="${typeValue}"]`).checked = true;
            
            // é …ç›®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°ã—ã¦ã‹ã‚‰é …ç›®ã‚’é¸æŠ
            updateItemSelect();
            document.getElementById('item').value = expense.item;
            
            // ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œæ›´æ–°ã€ã«å¤‰æ›´
            document.getElementById('submit-button').textContent = 'è¨˜éŒ²ã‚’æ›´æ–°';
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã™ã‚‹é–¢æ•°
        function exitEditMode() {
            editingExpenseId = null;
            document.getElementById('submit-button').textContent = 'è¨˜éŒ²ã‚’è¿½åŠ ';
            clearForm();
        }

        // å¹´ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
        function initializeYearSelect() {
            const yearSelect = document.getElementById('year-select');
            const currentYear = new Date().getFullYear();
            
            // ç¾åœ¨å¹´ã‹ã‚‰éå»3å¹´ã€æœªæ¥1å¹´ã®ç¯„å›²ã§ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
            const startYear = currentYear - 3;
            const endYear = currentYear + 1;
            
            // ã€Œå…¨ã¦ã®å¹´ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            const allYearOption = document.createElement('option');
            allYearOption.value = '';
            allYearOption.textContent = 'å…¨ã¦ã®å¹´';
            yearSelect.appendChild(allYearOption);
            
            // å¹´ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆæ–°ã—ã„å¹´ã‹ã‚‰é †ã«ï¼‰
            for (let year = endYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year + 'å¹´';
                yearSelect.appendChild(option);
            }
        }
        
        // ç¾åœ¨ã®å¹´æœˆã‚’é¸æŠã™ã‚‹é–¢æ•°
        function setCurrentYearMonth() {
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = (now.getMonth() + 1).toString().padStart(2, '0');
            
            document.getElementById('year-select').value = currentYear;
            document.getElementById('month-select').value = currentMonth;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function filterAndRenderRecords() {
            const selectedYear = document.getElementById('year-select').value;
            const selectedMonth = document.getElementById('month-select').value;
            
            let filteredData = expenses;
            
            // å¹´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (selectedYear) {
                filteredData = filteredData.filter(expense => {
                    const expenseYear = expense.date.split('-')[0];
                    return expenseYear === selectedYear;
                });
            }
            
            // æœˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (selectedMonth) {
                filteredData = filteredData.filter(expense => {
                    const expenseMonth = expense.date.split('-')[1];
                    return expenseMonth === selectedMonth;
                });
            }
            
            // æ—¥ä»˜ã§ä¸¦ã³æ›¿ãˆ
            filteredData.sort((a, b) => {
                if (sortOrder === 'desc') {
                    return new Date(b.date) - new Date(a.date); // æ–°â†’å¤
                } else {
                    return new Date(a.date) - new Date(b.date); // å¤â†’æ–°
                }
            });
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ä¸¦ã³æ›¿ãˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
            renderRecords(filteredData);
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§åˆè¨ˆã¨æ®‹é«˜ã‚’æ›´æ–°
            updateTotalWithFilteredData(filteredData);
        }
        
        // ä¸¦ã³æ›¿ãˆé †åºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function toggleSort() {
            if (sortOrder === 'desc') {
                sortOrder = 'asc';
                document.getElementById('sort-button').innerHTML = 'ğŸ“… æ—¥ä»˜ (å¤â†’æ–°)';
            } else {
                sortOrder = 'desc';
                document.getElementById('sort-button').innerHTML = 'ğŸ“… æ—¥ä»˜ (æ–°â†’å¤)';
            }
            
            // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã§å†æç”»
            filterAndRenderRecords();
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateTotalWithFilteredData(filteredData) {
            // åå…¥ã¨æ”¯å‡ºã‚’åˆ†ã‘ã¦è¨ˆç®—
            const income = filteredData
                .filter(expense => expense.type === 'income')
                .reduce((sum, expense) => sum + expense.amount, 0);
            
            const expenses = filteredData
                .filter(expense => (expense.type || 'expense') === 'expense')
                .reduce((sum, expense) => sum + expense.amount, 0);
            
            const total = income - expenses; // åå…¥ã‹ã‚‰æ”¯å‡ºã‚’å¼•ã„ãŸå®Ÿè³ªçš„ãªåæ”¯
            
            // åå…¥ãƒ»æ”¯å‡ºã‚’ãã‚Œãã‚Œè¡¨ç¤º
            document.getElementById('income-amount').textContent = `Â¥${income.toLocaleString()}`;
            document.getElementById('expense-amount').textContent = `Â¥${expenses.toLocaleString()}`;
            
            // æ®‹é«˜ã‚’æ›´æ–°ï¼ˆäºˆç®—ã¯å…¨ä½“ã®ã‚‚ã®ã‚’ä½¿ç”¨ã€æ”¯å‡ºã®ã¿ã§è¨ˆç®—ï¼‰
            const remaining = monthlyBudget - expenses;
            const remainingElement = document.getElementById('remaining-amount');
            remainingElement.textContent = `Â¥${remaining.toLocaleString()}`;
            
            // æ®‹é«˜ãŒãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯èµ¤è‰²ã§è¡¨ç¤º
            if (remaining < 0) {
                remainingElement.classList.add('negative');
            } else {
                remainingElement.classList.remove('negative');
            }
        }
        
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹é–¢æ•°
        function setupFilterEventListeners() {
            document.getElementById('year-select').addEventListener('change', function() {
                filterAndRenderRecords();
                updateReviewSummary();
            });
            document.getElementById('month-select').addEventListener('change', function() {
                filterAndRenderRecords();
                updateReviewSummary();
            });
        }

        // æœˆæ¬¡æŒ¯ã‚Šè¿”ã‚Šæ©Ÿèƒ½ã®å¤‰æ•°
        let currentReviewType = null; // 'best' or 'worst'
        let selectedExpenses = []; // é¸æŠã•ã‚ŒãŸæ”¯å‡ºã®IDé…åˆ—

        // ãƒ™ã‚¹ãƒˆãƒ»ãƒ¯ãƒ¼ã‚¹ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
        function showBestWorstSelection(type) {
            currentReviewType = type;
            selectedExpenses = [];
            
            const currentYear = document.getElementById('year-select').value || new Date().getFullYear().toString();
            const currentMonth = document.getElementById('month-select').value || (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            // é¸æŠã•ã‚ŒãŸå¹´æœˆã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæ”¯å‡ºã®ã¿ï¼‰
            const monthlyExpenses = expenses.filter(expense => {
                const expenseYear = expense.date.split('-')[0];
                const expenseMonth = expense.date.split('-')[1];
                return expenseYear === currentYear && expenseMonth === currentMonth && (expense.type || 'expense') === 'expense';
            });

            if (monthlyExpenses.length === 0) {
                alert(`${currentYear}å¹´${parseInt(currentMonth)}æœˆã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚`);
                return;
            }

            // UIã‚’æ›´æ–°
            const title = type === 'best' ? 'â­ ä»Šæœˆã®ãƒ™ã‚¹ãƒˆæ”¯å‡ºã‚’é¸æŠï¼ˆæœ€å¤§3ã¤ï¼‰' : 'âš ï¸ ä»Šæœˆã®ãƒ¯ãƒ¼ã‚¹ãƒˆæ”¯å‡ºã‚’é¸æŠï¼ˆæœ€å¤§3ã¤ï¼‰';
            document.getElementById('selection-title').textContent = title;
            
            // æ”¯å‡ºãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            displayExpenseSelectionList(monthlyExpenses, currentYear, currentMonth);
            
            // é¸æŠã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
            document.getElementById('review-selection-area').style.display = 'block';
            
            // æ—¢å­˜ã®é¸æŠãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãƒ­ãƒ¼ãƒ‰
            loadExistingReviewData(currentYear, currentMonth, type);
        }

        // æ”¯å‡ºé¸æŠãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        function displayExpenseSelectionList(monthlyExpenses, year, month) {
            const listContainer = document.getElementById('expense-selection-list');
            
            listContainer.innerHTML = monthlyExpenses.map(expense => `
                <div style="display: flex; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 8px; background-color: #fafafa;">
                    <input type="checkbox" id="expense-${expense.id}" value="${expense.id}" 
                           onchange="toggleExpenseSelection(${expense.id})"
                           style="margin-right: 12px; transform: scale(1.2);">
                    <label for="expense-${expense.id}" style="flex: 1; cursor: pointer; margin-bottom: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${expense.item}</strong>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 2px;">
                                    ${expense.date} ${expense.memo ? `â€¢ ${expense.memo}` : ''}
                                </div>
                            </div>
                            <div style="font-weight: bold; color: #dc3545;">
                                Â¥${expense.amount.toLocaleString()}
                            </div>
                        </div>
                    </label>
                </div>
            `).join('');
        }

        // æ”¯å‡ºé¸æŠã®ãƒˆã‚°ãƒ«å‡¦ç†
        function toggleExpenseSelection(expenseId) {
            const checkbox = document.getElementById(`expense-${expenseId}`);
            
            if (checkbox.checked) {
                if (selectedExpenses.length >= 3) {
                    checkbox.checked = false;
                    alert('æœ€å¤§3ã¤ã¾ã§é¸æŠã§ãã¾ã™ã€‚');
                    return;
                }
                selectedExpenses.push(expenseId);
            } else {
                selectedExpenses = selectedExpenses.filter(id => id !== expenseId);
            }
            
            updateSelectedItemsArea();
        }

        // é¸æŠã•ã‚ŒãŸé …ç›®ã®è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ›´æ–°
        function updateSelectedItemsArea() {
            const selectedItemsArea = document.getElementById('selected-items-area');
            
            if (selectedExpenses.length === 0) {
                selectedItemsArea.style.display = 'none';
                return;
            }
            
            selectedItemsArea.style.display = 'block';
            const typeText = currentReviewType === 'best' ? 'ãƒ™ã‚¹ãƒˆ' : 'ãƒ¯ãƒ¼ã‚¹ãƒˆ';
            
            selectedItemsArea.innerHTML = `
                <h4 style="color: #4a90e2; margin-bottom: 15px;">é¸æŠã—ãŸ${typeText}æ”¯å‡ºï¼ˆ${selectedExpenses.length}/3ï¼‰</h4>
                ${selectedExpenses.map(expenseId => {
                    const expense = expenses.find(exp => exp.id === expenseId);
                    return `
                        <div style="border: 1px solid #ddd; border-radius: 6px; padding: 15px; margin-bottom: 15px; background-color: #f9f9f9;">
                            <div style="font-weight: bold; margin-bottom: 8px;">
                                ${expense.item} - Â¥${expense.amount.toLocaleString()}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="font-weight: 600; margin-bottom: 5px; display: block;">
                                    é¸ã‚“ã ç†ç”±:
                                </label>
                                <textarea id="reason-${expenseId}" rows="3" placeholder="${currentReviewType === 'best' ? 'ä¾‹ï¼šé•·ãä½¿ãˆã‚‹ã‚‚ã®ã‚’è²·ãˆãŸã€ç´ æ™´ã‚‰ã—ã„ä½“é¨“ãŒã§ããŸ ãªã©' : 'ä¾‹ï¼šè¡å‹•è²·ã„ã ã£ãŸã€ã‚‚ã£ã¨å®‰ãæ¸ˆã¾ã›ã‚‰ã‚ŒãŸ ãªã©'}" 
                                          style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-family: inherit; resize: vertical;">${getExistingReason(expenseId) || ''}</textarea>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // æ—¢å­˜ã®æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
        function loadExistingReviewData(year, month, type) {
            const reviewKey = `${year}-${month}`;
            const existingReview = monthlyReviews[reviewKey];
            
            if (existingReview && existingReview[type]) {
                selectedExpenses = existingReview[type].map(item => item.expenseId);
                
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
                selectedExpenses.forEach(expenseId => {
                    const checkbox = document.getElementById(`expense-${expenseId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                
                updateSelectedItemsArea();
            }
        }

        // æ—¢å­˜ã®ç†ç”±ã‚’å–å¾—
        function getExistingReason(expenseId) {
            const currentYear = document.getElementById('year-select').value || new Date().getFullYear().toString();
            const currentMonth = document.getElementById('month-select').value || (new Date().getMonth() + 1).toString().padStart(2, '0');
            const reviewKey = `${currentYear}-${currentMonth}`;
            const existingReview = monthlyReviews[reviewKey];
            
            if (existingReview && existingReview[currentReviewType]) {
                const item = existingReview[currentReviewType].find(item => item.expenseId === expenseId);
                return item ? item.reason : '';
            }
            return '';
        }

        // æœˆæ¬¡æŒ¯ã‚Šè¿”ã‚Šã‚’ä¿å­˜
        function saveMonthlyReview() {
            if (selectedExpenses.length === 0) {
                alert('å°‘ãªãã¨ã‚‚1ã¤ã®æ”¯å‡ºã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const currentYear = document.getElementById('year-select').value || new Date().getFullYear().toString();
            const currentMonth = document.getElementById('month-select').value || (new Date().getMonth() + 1).toString().padStart(2, '0');
            const reviewKey = `${currentYear}-${currentMonth}`;
            
            // ç†ç”±ã‚’åé›†
            const reviewItems = selectedExpenses.map(expenseId => {
                const expense = expenses.find(exp => exp.id === expenseId);
                const reasonTextarea = document.getElementById(`reason-${expenseId}`);
                const reason = reasonTextarea ? reasonTextarea.value.trim() : '';
                
                return {
                    expenseId: expenseId,
                    item: expense.item,
                    amount: expense.amount,
                    date: expense.date,
                    memo: expense.memo || '',
                    reason: reason
                };
            });
            
            // æœˆæ¬¡æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            if (!monthlyReviews[reviewKey]) {
                monthlyReviews[reviewKey] = {};
            }
            monthlyReviews[reviewKey][currentReviewType] = reviewItems;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            saveDataToStorage();
            
            // UIæ›´æ–°
            cancelSelection();
            updateReviewSummary();
            
            const typeText = currentReviewType === 'best' ? 'ãƒ™ã‚¹ãƒˆ' : 'ãƒ¯ãƒ¼ã‚¹ãƒˆ';
            alert(`${typeText}æ”¯å‡ºã®æŒ¯ã‚Šè¿”ã‚Šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
        }

        // é¸æŠã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelSelection() {
            document.getElementById('review-selection-area').style.display = 'none';
            currentReviewType = null;
            selectedExpenses = [];
        }

        // æŒ¯ã‚Šè¿”ã‚Šã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
        function updateReviewSummary() {
            const currentYear = document.getElementById('year-select').value || new Date().getFullYear().toString();
            const currentMonth = document.getElementById('month-select').value || (new Date().getMonth() + 1).toString().padStart(2, '0');
            const reviewKey = `${currentYear}-${currentMonth}`;
            const review = monthlyReviews[reviewKey];
            
            const summaryContent = document.getElementById('review-summary-content');
            
            if (!review || (!review.best && !review.worst)) {
                summaryContent.innerHTML = `
                    <p style="color: #888; text-align: center; font-style: italic;">
                        ${currentYear}å¹´${parseInt(currentMonth)}æœˆã®æŒ¯ã‚Šè¿”ã‚Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                        ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä»Šæœˆã®ãƒ™ã‚¹ãƒˆãƒ»ãƒ¯ãƒ¼ã‚¹ãƒˆæ”¯å‡ºã‚’é¸ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼
                    </p>
                `;
                return;
            }
            
            let html = `<h4 style="color: #666; margin-bottom: 15px;">${currentYear}å¹´${parseInt(currentMonth)}æœˆã®æŒ¯ã‚Šè¿”ã‚Š</h4>`;
            
            if (review.best && review.best.length > 0) {
                html += `
                    <div style="margin-bottom: 25px;">
                        <h5 style="color: #28a745; margin-bottom: 10px; display: flex; align-items: center;">
                            â­ ãƒ™ã‚¹ãƒˆæ”¯å‡º (${review.best.length}ä»¶)
                        </h5>
                        ${review.best.map((item, index) => `
                            <div style="background-color: #f8fff8; border-left: 4px solid #28a745; padding: 12px; margin-bottom: 10px; border-radius: 0 6px 6px 0;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                    ${index + 1}. ${item.item} - Â¥${item.amount.toLocaleString()}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                                    ${item.date} ${item.memo ? `â€¢ ${item.memo}` : ''}
                                </div>
                                <div style="font-size: 0.9rem; color: #555; background-color: white; padding: 8px; border-radius: 4px; border: 1px solid #e0e0e0;">
                                    <strong>ç†ç”±:</strong> ${item.reason || 'ï¼ˆç†ç”±ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (review.worst && review.worst.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h5 style="color: #dc3545; margin-bottom: 10px; display: flex; align-items: center;">
                            âš ï¸ ãƒ¯ãƒ¼ã‚¹ãƒˆæ”¯å‡º (${review.worst.length}ä»¶)
                        </h5>
                        ${review.worst.map((item, index) => `
                            <div style="background-color: #fff8f8; border-left: 4px solid #dc3545; padding: 12px; margin-bottom: 10px; border-radius: 0 6px 6px 0;">
                                <div style="font-weight: bold; color: #333; margin-bottom: 5px;">
                                    ${index + 1}. ${item.item} - Â¥${item.amount.toLocaleString()}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 8px;">
                                    ${item.date} ${item.memo ? `â€¢ ${item.memo}` : ''}
                                </div>
                                <div style="font-size: 0.9rem; color: #555; background-color: white; padding: 8px; border-radius: 4px; border: 1px solid #e0e0e0;">
                                    <strong>ç†ç”±:</strong> ${item.reason || 'ï¼ˆç†ç”±ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            summaryContent.innerHTML = html;
        }

        // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã¨ãã«åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', initializeApp);

        // PWAå¯¾å¿œ: Service Workerç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                const swCode = `
                    const CACHE_NAME = 'kakeibo-app-v1';
                    const urlsToCache = [
                        '/',
                        '/index.html'
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                }
                            )
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorkerç™»éŒ²æˆåŠŸ:', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorkerç™»éŒ²å¤±æ•—:', err);
                    });
            });
        }

        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿ƒé€²
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            const installButton = document.createElement('button');
            installButton.textContent = 'ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ';
            installButton.className = 'btn';
            installButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; background-color: #28a745; box-shadow: 0 4px 8px rgba(0,0,0,0.2);';
            
            installButton.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰¿è«¾');
                    }
                    deferredPrompt = null;
                    document.body.removeChild(installButton);
                });
            });
            
            document.body.appendChild(installButton);
            
            // 3ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
            setTimeout(() => {
                if (document.body.contains(installButton)) {
                    document.body.removeChild(installButton);
                }
            }, 5000);
        });
    </script>
</body>
</html>